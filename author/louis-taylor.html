<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="../theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="../theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="../theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Louis Taylor">
  <meta name="description" content="Posts and writings by Louis Taylor">

  <link href="https://blog.kragniz.eu/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="blog.kragniz.eu Atom" />


  <title>
    blog.kragniz.eu
&ndash; Posts by: Louis Taylor  </title>

</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="..">
        <img src="https://blog.kragniz.eu/images/me2_cropped.png" alt="logo">
      </a>
      <h2><a href="..">Louis Taylor</a></h2>
      <p>ミ๏ｖ๏彡</p>
      <ul>
        <li><a href="https://github.com/kragniz" target="_blank">GitHub</a></li>
        <li><a href="https://chaos.social/@kgz" target="_blank">fedi</a></li>
      </ul>
    </div>
  </aside>

  <main>

<article>
  <div class="article_title">
    <h3><a href="../raspbian-on-travis-ci">Raspbian on Travis CI</a></h3>
  </div>
  <div class="article_text">
    <p>For abersailbot, I've been working on automation of provisioning images to run
on the main raspberry pi inside the boat. In the past, this has been a
primitive bash script which installs packages and configurations files with a
dubious amount of calls out to apt, cp and sed. Wanting to make this a little
more sophisticated, I started writing a set of ansible playbooks.</p>
<p>For testing other repositories, I normally always use
<a class="reference external" href="https://travis-ci.org">https://travis-ci.org</a>. If you're not familiar, Travis CI offers free CI
resources for open source repositories. The VMs it boots are all Ubuntu on
x86_64, however. In order to test things on raspbian, some hacks would be
needed.</p>
<p>Options I considered:</p>
<ol class="arabic simple">
<li>No testing (no tests? What madness!)</li>
<li>ARM chroot</li>
<li>Raspbian fat Docker container</li>
<li>Raspbian image booted under QEMU</li>
</ol>
<p>After some playing around, the QEMU route seemed like the best option. If you'd
like to do the same, the steps I took are fairly simple:</p>
<p>First off, we need to get a disk image. The images provided from the Raspberry
Pi site need some small modifications to run under QEMU, so we need to mount
and edit it. I'm using the <tt class="docutils literal"><span class="pre">2015-11-21-raspbian-jessie-lite.img</span></tt> image from
<a class="reference external" href="https://www.raspberrypi.org/downloads/raspbian/">https://www.raspberrypi.org/downloads/raspbian/</a>.</p>
<p>This image contains two partitions, a small boot partition (FAT) which contains
a few config files and a kernel, and the main ext4 root partition. The latter
is the partition we're interested in. You can inspect the image with <tt class="docutils literal">fdisk</tt>
to show these:</p>
<pre class="literal-block">
~/g/dewi (master) $ fdisk -l 2015-11-21-raspbian-jessie-lite.img
Disk 2015-11-21-raspbian-jessie-lite.img: 1.4 GiB, 1458569216 bytes, 2848768 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xb3c5e39a

Device                               Boot  Start     End Sectors  Size Id Type
2015-11-21-raspbian-jessie-lite.img1        8192  131071  122880   60M  c W95 FAT32 (LBA)
2015-11-21-raspbian-jessie-lite.img2      131072 2848767 2717696  1.3G 83 Linux
</pre>
<p>Note the start of the partition we're interested in (131072). This is the
offset from the start of the image in terms of number of sectors. The sector
size is 512, so the actual offset in terms of bytes is 131072 × 512 =
67108864.</p>
<p>Armed with this knowledge, we can mount the image and edit files on it
interactively.</p>
<p>First, create a directory to mount the image:</p>
<pre class="literal-block">
$ mkdir raspbian-jessie-mount-point
</pre>
<p>then mount the image:</p>
<pre class="literal-block">
$ sudo mount -o loop,offset=67108864 2015-11-21-raspbian-jessie-lite.img \
  raspbian-jessie-mount-point
</pre>
<p>Now it's time to comment out a bunch of things.</p>
<ol class="arabic simple">
<li>Open <tt class="docutils literal"><span class="pre">raspbian-jessie-mount-point/etc/ld.so.preload</span></tt> in an editor of your
choice and comment out all lines.</li>
<li>Do the same and comment out all lines related to <tt class="docutils literal">mmccblk</tt> in
<tt class="docutils literal"><span class="pre">raspbian-jessie-mount-point/etc/fstab</span></tt></li>
</ol>
<p>After these edits have been made, unmount the image:</p>
<pre class="literal-block">
$ sudo umount raspbian-jessie-mount-point
</pre>
<p>The modified image can now be saved and backed up somewhere. I took a copy and
compressed it to save on space:</p>
<pre class="literal-block">
$ xz 2015-11-21-raspbian-jessie-lite.img
</pre>
<p>Now we have an image to boot, we need a kernel to run. Sadly, a modified
kernel is required, since QEMU does not support raspberry pi hardware. Luckily
the work of patching and building has already been done by someone else.
<a class="reference external" href="https://github.com/polaco1782/raspberry-qemu">https://github.com/polaco1782/raspberry-qemu</a> appears to work well.</p>
<p>Clone that repository and copy <tt class="docutils literal"><span class="pre">kernel-qemu</span></tt>:</p>
<pre class="literal-block">
$ git clone git&#64;github.com:polaco1782/raspberry-qemu.git
$ cp raspberry-qemu/kernel-qemu .
</pre>
<p>At this point, booting should be possible. To test, first install
<tt class="docutils literal"><span class="pre">qemu-system-arm</span></tt>.</p>
<p>If you're on Fedora:</p>
<pre class="literal-block">
$ sudo dnf install qemu-system-arm
</pre>
<p>Or Debian/Ubuntu:</p>
<pre class="literal-block">
$ sudo apt install qemu-system-arm
</pre>
<p>Then run:</p>
<pre class="literal-block">
$ qemu-system-arm \
    -kernel kernel-qemu \
    -cpu arm1176 \
    -m 256 \
    -M versatilepb \
    -no-reboot \
    -serial stdio \
    -display none \
    -append &quot;root=/dev/sda2 panic=1 rootfstype=ext4 rw&quot; \
    -net user,hostfwd=tcp::10022-:22 \
    -net nic -hda \
    2015-11-21-raspbian-jessie-lite.img
</pre>
<p>Note the option <tt class="docutils literal"><span class="pre">-net</span> <span class="pre">user,hostfwd=tcp::10022-:22</span></tt>. This forwards port 22 on
raspbian to 10022 on the host, allowing us to ssh into the booted VM.</p>
<p>You should see some output similar to:</p>
<pre class="literal-block">
pulseaudio: pa_context_connect() failed
pulseaudio: Reason: Connection refused
pulseaudio: Failed to initialize PA contextaudio: Could not init `pa' audio driver
ALSA lib confmisc.c:768:(parse_card) cannot find card '0'
ALSA lib conf.c:4248:(_snd_config_evaluate) function snd_func_card_driver returned error: No such file or directory
ALSA lib confmisc.c:392:(snd_func_concat) error evaluating strings
ALSA lib conf.c:4248:(_snd_config_evaluate) function snd_func_concat returned error: No such file or directory
ALSA lib confmisc.c:1251:(snd_func_refer) error evaluating name
ALSA lib conf.c:4248:(_snd_config_evaluate) function snd_func_refer returned error: No such file or directory
ALSA lib conf.c:4727:(snd_config_expand) Evaluate error: No such file or directory
ALSA lib pcm.c:2239:(snd_pcm_open_noupdate) Unknown PCM default
alsa: Could not initialize DAC
alsa: Failed to open `default':
alsa: Reason: No such file or directory
ALSA lib confmisc.c:768:(parse_card) cannot find card '0'
ALSA lib conf.c:4248:(_snd_config_evaluate) function snd_func_card_driver returned error: No such file or directory
ALSA lib confmisc.c:392:(snd_func_concat) error evaluating strings
ALSA lib conf.c:4248:(_snd_config_evaluate) function snd_func_concat returned error: No such file or directory
ALSA lib confmisc.c:1251:(snd_func_refer) error evaluating name
ALSA lib conf.c:4248:(_snd_config_evaluate) function snd_func_refer returned error: No such file or directory
ALSA lib conf.c:4727:(snd_config_expand) Evaluate error: No such file or directory
ALSA lib pcm.c:2239:(snd_pcm_open_noupdate) Unknown PCM default
alsa: Could not initialize DAC
alsa: Failed to open `default':
alsa: Reason: No such file or directory
audio: Failed to create voice `lm4549.out'
Uncompressing Linux... done, booting the kernel.
</pre>
<p>Test if a login works:</p>
<pre class="literal-block">
$ ssh localhost -o StrictHostKeyChecking=no -p 10022 -l pi
</pre>
<p>The password should be the default <tt class="docutils literal">raspberry</tt>, unless you changed it
earlier.</p>
<p>If this all works, you can start writing your <tt class="docutils literal">.travis.yml</tt> to boot this VM
on Travis CI runs. You should first enable travis commit hooks on your
repository (read the <a class="reference external" href="https://docs.travis-ci.com/user/getting-started/">getting started guide</a>), then start writing a
configuration file. A simple version of the config file to start off:</p>
<div class="highlight"><pre><span></span><span class="n">language</span><span class="p">:</span> <span class="n">generic</span>
<span class="n">sudo</span><span class="p">:</span> <span class="n">true</span>
<span class="n">dist</span><span class="p">:</span> <span class="n">trusty</span>

<span class="n">before_install</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
    <span class="o">-</span> <span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">arm</span> <span class="n">wget</span> <span class="n">xz</span><span class="o">-</span><span class="n">utils</span> <span class="n">sshpass</span>

<span class="n">install</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">wget</span> <span class="s2">&quot;https://super-secret-location.com/2015-11-21-raspbian-jessie-lite.img.xz&quot;</span>
    <span class="o">-</span> <span class="n">unxz</span> <span class="s2">&quot;2015-11-21-raspbian-jessie-lite.img.xz&quot;</span>
    <span class="o">-</span> <span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">polaco1782</span><span class="o">/</span><span class="n">raspberry</span><span class="o">-</span><span class="n">qemu</span><span class="o">.</span><span class="n">git</span>

<span class="n">before_script</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">arm</span> <span class="o">-</span><span class="n">kernel</span> <span class="n">raspberry</span><span class="o">-</span><span class="n">qemu</span><span class="o">/</span><span class="n">kernel</span><span class="o">-</span><span class="n">qemu</span> <span class="o">-</span><span class="n">cpu</span> <span class="n">arm1176</span> <span class="o">-</span><span class="n">m</span> <span class="mi">256</span> <span class="o">-</span><span class="n">M</span> <span class="n">versatilepb</span> <span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">reboot</span> <span class="o">-</span><span class="n">serial</span> <span class="n">stdio</span> <span class="o">-</span><span class="n">append</span> <span class="s2">&quot;root=/dev/sda2 panic=1 rootfstype=ext4 rw&quot;</span> <span class="o">-</span><span class="n">net</span> <span class="n">user</span><span class="p">,</span><span class="n">hostfwd</span><span class="o">=</span><span class="n">tcp</span><span class="p">::</span><span class="mi">10022</span><span class="o">-</span><span class="p">:</span><span class="mi">22</span> <span class="o">-</span><span class="n">net</span> <span class="n">nic</span> <span class="o">-</span><span class="n">display</span> <span class="n">none</span> <span class="o">-</span><span class="n">hda</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="n">raspbian</span><span class="o">-</span><span class="n">jessie</span><span class="o">-</span><span class="n">lite</span><span class="o">.</span><span class="n">img</span> <span class="o">&amp;</span>
    <span class="o">-</span> <span class="o">./</span><span class="n">test</span><span class="o">/</span><span class="n">wait</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="n">ssh</span>

<span class="n">script</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">sshpass</span> <span class="o">-</span><span class="n">p</span> <span class="n">raspberry</span> <span class="n">ssh</span> <span class="n">localhost</span> <span class="o">-</span><span class="n">o</span> <span class="n">StrictHostKeyChecking</span><span class="o">=</span><span class="n">no</span> <span class="o">-</span><span class="n">p</span> <span class="mi">10022</span> <span class="o">-</span><span class="n">l</span> <span class="n">pi</span> <span class="s2">&quot;cat /etc/os-release&quot;</span>
    <span class="c1"># whatever you want to test here</span>
</pre></div>
<p>You should note this requires a mirror of the image created in the earlier
steps. Each CI run will have to download and decompress the image. With Travis
Pro, I believe you might be able to do something different and cache it, but I
didn't investigate this.</p>
<p>This runs <tt class="docutils literal"><span class="pre">qemu-system-arm</span></tt> in the background. In order to wait until the VM
is ready, I made a crude script named <tt class="docutils literal"><span class="pre">wait-for-ssh</span></tt> to ping the ssh port
until it responded:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>

<span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>nc<span class="w"> </span>-z<span class="w"> </span>localhost<span class="w"> </span><span class="m">10022</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Found something on port 10022!&quot;</span>
<span class="w">        </span><span class="nb">exit</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Nothing found on port 10022, sleeping...&quot;</span>
<span class="w">        </span>sleep<span class="w"> </span><span class="m">10</span>
<span class="w">    </span><span class="k">fi</span>
<span class="k">done</span>
</pre></div>
<p>When this is done, you can actually test the stuff you wanted to test in the
first place! In the example <tt class="docutils literal">.travis.yml</tt>, I do a sanity check and cat
<tt class="docutils literal"><span class="pre">/etc/os-release</span></tt>, expecting something like:</p>
<pre class="literal-block">
PRETTY_NAME=&quot;Raspbian GNU/Linux 8 (jessie)&quot;
NAME=&quot;Raspbian GNU/Linux&quot;
VERSION_ID=&quot;8&quot;
VERSION=&quot;8 (jessie)&quot;
ID=raspbian
ID_LIKE=debian
HOME_URL=&quot;http://www.raspbian.org/&quot;
SUPPORT_URL=&quot;http://www.raspbian.org/RaspbianForums&quot;
BUG_REPORT_URL=&quot;http://www.raspbian.org/RaspbianBugs&quot;
</pre>
<p>Now you have a little Raspbian VM booted on every commit. Run some ansible or
puppet against it and you're done. Happy testing!</p>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h3><a href="../kpatch-package-builder">kpatch-package-builder 0.1.0</a></h3>
  </div>
  <div class="article_text">
    <p>As part of <a class="reference external" href="https://developers.google.com/open-source/gsoc/">Google Summer of Code</a>, I've been working with the
CentOS project to create a delivery and build system to provide easy and
automatic delivery of patches to a running linux kernel. CentOS 7 currently has
support for live patching a running kernel (via the kpatch kernel module and
the surrounding userland tools), but crafting a patch and applying it is a
currently a very manual process. The overall aim of the project is to make
applying kernel fixes an easy and automatic process, which will make it easier
to keep a CentOS installation more secure by without having to schedule
downtime.</p>
<p>As the first part of this project, I've been writing
<tt class="docutils literal"><span class="pre">kpatch-package-builder</span></tt>, a tool which generates RPM packages containing a
kernel module which patchs the currently running kernel.  These distributable
packages contain a single kernel patch, so standard package management tools,
such as dnf and yum can install and manage them.</p>
<p>This first version is pretty simple. You create a patch against the source of the
kernel you want to modify, then run <tt class="docutils literal"><span class="pre">kpatch-package-builder</span></tt> with the patch
name as the last argument. The output can either be a built .rpm file, or the
raw spec.</p>
<p>By default <tt class="docutils literal"><span class="pre">kpatch-package-builder</span></tt> outputs an RPM .spec file, which can be
used to build the RPM. This is a very simple spec, which just specifies the
name of the package, description, and other common package metadata. The name
of the package currently is based off the patch filename with a prefix of
<tt class="docutils literal"><span class="pre">kpatch-module-</span></tt>, which allows these packages to be simply distinguished.
Future versions will have a series of virtual dependencies to prevent patch
collisions, but that's something for a future post.</p>
<p>When given the <tt class="docutils literal"><span class="pre">-b</span></tt> or <tt class="docutils literal"><span class="pre">--build-rpm</span></tt> option, <tt class="docutils literal"><span class="pre">kpatch-package-builder</span></tt>
will invoke rpmbuild and build the package in place. The makes the kernel patch
to distributable package a single step.</p>
<p>As an example, creating a package from a patch file:</p>
<pre class="code bash literal-block">
<span class="o">[</span>vagrant&#64;localhost<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>kpatch-package-builder<span class="w"> </span>-b<span class="w"> </span>livepatch-test.patch<span class="w">
</span>kpatch-package-builder:<span class="w"> </span>generating<span class="w"> </span>spec<span class="w"> </span>file...<span class="w">
</span>kpatch-package-builder:<span class="w"> </span>building<span class="w"> </span>RPM...<span class="w">
</span>kpatch-package-builder:<span class="w"> </span>writing<span class="w"> </span>spec<span class="w"> </span>file<span class="w"> </span>to<span class="w"> </span>/tmp/kpatch_3I6mHJ.spec...<span class="w">
</span>kpatch-package-builder:<span class="w"> </span>writing<span class="w"> </span>kpatch-module-livepatch-test-1-1.x86_64.rpm...
</pre>
<p>The default metadata associated with that generated package:</p>
<pre class="code bash literal-block">
<span class="o">[</span>vagrant&#64;localhost<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>rpm<span class="w"> </span>-qip<span class="w"> </span>kpatch-module-livepatch-test-1-1.x86_64.rpm<span class="w">
</span>Name<span class="w">        </span>:<span class="w"> </span>kpatch-module-livepatch-test<span class="w">
</span>Version<span class="w">     </span>:<span class="w"> </span><span class="m">1</span><span class="w">
</span>Release<span class="w">     </span>:<span class="w"> </span><span class="m">1</span><span class="w">
</span>Architecture:<span class="w"> </span>x86_64<span class="w">
</span>Install<span class="w"> </span>Date:<span class="w"> </span><span class="o">(</span>not<span class="w"> </span>installed<span class="o">)</span><span class="w">
</span>Group<span class="w">       </span>:<span class="w"> </span>System<span class="w"> </span>Environment/Kernel<span class="w">
</span>Size<span class="w">        </span>:<span class="w"> </span><span class="m">281661</span><span class="w">
</span>License<span class="w">     </span>:<span class="w"> </span>GPLv2<span class="w">
</span>Signature<span class="w">   </span>:<span class="w"> </span><span class="o">(</span>none<span class="o">)</span><span class="w">
</span>Source<span class="w"> </span>RPM<span class="w">  </span>:<span class="w"> </span>kpatch-module-livepatch-test-1-1.src.rpm<span class="w">
</span>Build<span class="w"> </span>Date<span class="w">  </span>:<span class="w"> </span>Wed<span class="w"> </span><span class="m">24</span><span class="w"> </span>Jun<span class="w"> </span><span class="m">2015</span><span class="w"> </span><span class="m">15</span>:26:46<span class="w"> </span>EDT<span class="w">
</span>Build<span class="w"> </span>Host<span class="w">  </span>:<span class="w"> </span>localhost<span class="w">
</span>Relocations<span class="w"> </span>:<span class="w"> </span><span class="o">(</span>not<span class="w"> </span>relocatable<span class="o">)</span><span class="w">
</span>Summary<span class="w">     </span>:<span class="w"> </span>kpatch<span class="w"> </span>livepatch<span class="w"> </span>module<span class="w">
</span>Description<span class="w"> </span>:<span class="w">
</span>Package<span class="w"> </span>generated<span class="w"> </span>from<span class="w"> </span>livepatch-test.patch<span class="w"> </span>by<span class="w"> </span>kpatch-package-builder
</pre>
<p>The contents of the package:</p>
<pre class="code bash literal-block">
<span class="o">[</span>vagrant&#64;localhost<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>rpm<span class="w"> </span>-qlp<span class="w"> </span>kpatch-module-livepatch-test-1-1.x86_64.rpm<span class="w">
</span>/var/lib/kpatch/3.10.0-229.el7.x86_64/kpatch-livepatch-test.ko
</pre>
<p>The current options available:</p>
<pre class="code bash literal-block">
<span class="o">[</span>vagrant&#64;localhost<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>kpatch-package-builder<span class="w"> </span>-h<span class="w">
</span>usage:<span class="w"> </span>kpatch-package-builder<span class="w"> </span><span class="o">[</span>-h<span class="o">]</span><span class="w"> </span><span class="o">[</span>-v<span class="o">]</span><span class="w"> </span><span class="o">[</span>-o<span class="w"> </span>FILE<span class="w"> </span><span class="p">|</span><span class="w"> </span>-b<span class="o">]</span><span class="w"> </span><span class="o">[</span>-k<span class="w"> </span>VERSION<span class="o">]</span><span class="w"> </span><span class="o">[</span>-a<span class="w"> </span>ARCH<span class="o">]</span><span class="w">
                              </span><span class="o">[</span>--set-release<span class="w"> </span>NUM<span class="o">]</span><span class="w"> </span><span class="o">[</span>--set-version<span class="w"> </span>NUM<span class="o">]</span><span class="w"> </span><span class="o">[</span>-d<span class="o">]</span><span class="w">
                              </span>PATCH<span class="w">

</span>Build<span class="w"> </span>an<span class="w"> </span>RPM<span class="w"> </span>package<span class="w"> </span>or<span class="w"> </span>an<span class="w"> </span>RPM<span class="w"> </span>spec<span class="w"> </span>file<span class="w"> </span>to<span class="w"> </span>install<span class="w"> </span>and<span class="w"> </span>manage<span class="w"> </span>a<span class="w"> </span>kpatch<span class="w">
</span>livepatch<span class="w"> </span>module.<span class="w">

</span>positional<span class="w"> </span>arguments:<span class="w">
  </span>PATCH<span class="w">                 </span>patch<span class="w"> </span>file<span class="w"> </span>from<span class="w"> </span>which<span class="w"> </span>to<span class="w"> </span>build<span class="w"> </span>the<span class="w"> </span>livepatch<span class="w"> </span>module<span class="w">

</span>optional<span class="w"> </span>arguments:<span class="w">
  </span>-h,<span class="w"> </span>--help<span class="w">            </span>show<span class="w"> </span>this<span class="w"> </span><span class="nb">help</span><span class="w"> </span>message<span class="w"> </span>and<span class="w"> </span><span class="nb">exit</span><span class="w">
  </span>-v,<span class="w"> </span>--version<span class="w">         </span>show<span class="w"> </span>program<span class="err">'</span>s<span class="w"> </span>version<span class="w"> </span>number<span class="w"> </span>and<span class="w"> </span><span class="nb">exit</span><span class="w">
  </span>-o<span class="w"> </span>FILE,<span class="w"> </span>--output<span class="w"> </span>FILE<span class="w">
                        </span>name<span class="w"> </span>of<span class="w"> </span>output<span class="w"> </span>spec<span class="w"> </span>file<span class="w">
  </span>-b,<span class="w"> </span>--build-rpm<span class="w">       </span>build<span class="w"> </span>an<span class="w"> </span>RPM<span class="w"> </span>package<span class="w">
  </span>-k<span class="w"> </span>VERSION,<span class="w"> </span>--kernel<span class="w"> </span>VERSION<span class="w">
                        </span>target<span class="w"> </span>kernel<span class="w"> </span>version<span class="w"> </span>to<span class="w"> </span>build<span class="w"> </span>the<span class="w"> </span>livepatch<span class="w"> </span>module<span class="w">
                        </span>against.<span class="w"> </span>Defaults<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>currently<span class="w"> </span>running<span class="w"> </span>version<span class="w">
  </span>-a<span class="w"> </span>ARCH,<span class="w"> </span>--arch<span class="w"> </span>ARCH<span class="w">  </span>architecture<span class="w"> </span>to<span class="w"> </span>compile<span class="w"> </span>the<span class="w"> </span>patch<span class="w"> </span>against<span class="w">
  </span>--set-release<span class="w"> </span>NUM<span class="w">     </span>package<span class="w"> </span>release<span class="w"> </span>version<span class="w">
  </span>--set-version<span class="w"> </span>NUM<span class="w">     </span>package<span class="w"> </span>version<span class="w"> </span>number<span class="w">
  </span>-d,<span class="w"> </span>--debug<span class="w">           </span>print<span class="w"> </span>debug<span class="w"> </span>information<span class="w">

</span>Usage<span class="w"> </span>examples:<span class="w">

</span>Build<span class="w"> </span>an<span class="w"> </span>RPM<span class="w"> </span>package<span class="w"> </span><span class="k">for</span><span class="w"> </span>a<span class="w"> </span>given<span class="w"> </span>patch:<span class="w">

    </span>$<span class="w"> </span>kpatch-package-builder<span class="w"> </span>--build-rpm<span class="w"> </span>module.patch<span class="w">

</span>Generate<span class="w"> </span>a<span class="w"> </span>spec<span class="w"> </span>file<span class="w"> </span>to<span class="w"> </span>later<span class="w"> </span>build<span class="w"> </span>into<span class="w"> </span>an<span class="w"> </span>RPM:<span class="w">

    </span>$<span class="w"> </span>kpatch-package-builder<span class="w"> </span>--output<span class="w"> </span>module.spec<span class="w"> </span>module.patch
</pre>
<p>If you want to test this or use it yourself, the code lives at <a class="reference external" href="https://github.com/centos-livepatching/kpatch-package-builder">https://github.com/centos-livepatching/kpatch-package-builder</a>.</p>
<div class="section" id="future-work">
<h2>Future work</h2>
<p>Next up is the rest of the tooling to make building and distributing a series
of patches across a set of kernel versions easy. This will be working on top of
the basic kpatch-package-builder functionality to allow building many versions
of packages for particular kernels.</p>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h3><a href="../vagrant-fedora-21">Vagrant on fedora 21 and later</a></h3>
  </div>
  <div class="article_text">
    <p>Vagrant is <a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1020456">now packaged</a> in Fedora 21 and later versions, which is great news.
No more messing around with the horror of rvm!</p>
<p>After installing vagrant and the libvirt plugin with yum:</p>
<pre class="literal-block">
$ sudo yum install vagrant vagrant-libvirt
</pre>
<p>I got some syntax errors from Vagrant:</p>
<pre class="literal-block">
$ vagrant up
/usr/share/vagrant/lib/vagrant/pre-rubygems.rb:19:in `require_relative': /usr/share/vagrant/lib/vagrant/bundler.rb:217: syntax error, unexpected tPOW (SyntaxError)
    def internal_install(plugins, update, **extra)
                                            ^
/usr/share/vagrant/lib/vagrant/bundler.rb:298: class definition in method body
/usr/share/vagrant/lib/vagrant/bundler.rb:315: class definition in method body
/usr/share/vagrant/lib/vagrant/bundler.rb:368: syntax error, unexpected keyword_end, expecting $end
    from /usr/share/vagrant/lib/vagrant/pre-rubygems.rb:19:in `&lt;main&gt;'
</pre>
<p>This was caused by rvm having an old version of ruby installed, which is what
was installed when I installed vagrant on this machine initially:</p>
<pre class="literal-block">
$ ruby --version
ruby 1.9.3p545 (2014-02-24 revision 45159) [x86_64-linux]
</pre>
<p>Luckily you can just:</p>
<pre class="literal-block">
$ rvm implode
</pre>
<p>and everything will be happy, where happy is defined by vagrant running and
having the fewest versions of ruby installed.</p>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h3><a href="../interlude">A brief five year interlude</a></h3>
  </div>
  <div class="article_text">
    <p>I've since done my GCSE and A-level exams, and am now half way
through university.</p>
<p>Some sailing robots made with friends from my university:</p>
<img alt="" src="../images/dewi.jpg" />
<img alt="" src="../images/kitty.jpg" />
<p>Old posts begin here:</p>

  </div>
</article>

<footer>
<div id="paginator">
<a href="../author/louis-taylor2.html" class="button_accent">&larr; Older Posts</a>

</div>
</footer>

    <div id="ending_message">
      <p>&copy; Louis Taylor. <a href="..">Index</a> &brvbar; <a href="../archives.html">Archives</a> &brvbar; <a href="http://getpelican.com" target="_blank">Pelican</a> &brvbar; <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">Theme</a>.</p>
    </div>
  </main>
</body>
</html>