<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="./theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="./theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="./theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Louis Taylor">
  <meta name="description" content="Posts and writings by Louis Taylor">

  <link href="http://blog.kragniz.eu/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="blog.kragniz.eu Atom" />


  <title>
    blog.kragniz.eu
  </title>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-59782204-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a href=".">
        <img src="http://blog.kragniz.eu/images/me2_waifu2x_waifu2x.png" alt="logo">
      </a>
      <h2><a href=".">Louis Taylor</a></h2>
      <p>ミ๏ｖ๏彡</p>
      <ul>
        <li><a href="http://github.com/kragniz" target="_blank">Github</a></li>
        <li><a href="https://twitter.com/kragniz" target="_blank">Twitter</a></li>
      </ul>
    </div>
  </aside>

  <main>

<article>
  <div class="article_title">
    <h3><a href="./raspbian-on-travis-ci">Raspbian on Travis CI</a></h3>
  </div>
  <div class="article_text">
    <p>For abersailbot, I've been working on automation of provisioning images to run
on the main raspberry pi inside the boat. In the past, this has been a
primitive bash script which installs packages and configurations files with a
dubious amount of calls out to apt, cp and sed. Wanting to make this a little
more sophisticated, I started writing a set of ansible playbooks.</p>
<p>For testing other repositories, I normally always use
<a class="reference external" href="https://travis-ci.org">https://travis-ci.org</a>. If you're not familiar, Travis CI offers free CI
resources for open source repositories. The VMs it boots are all Ubuntu on
x86_64, however. In order to test things on raspbian, some hacks would be
needed.</p>
<p>Options I considered:</p>
<ol class="arabic simple">
<li>No testing (no tests? What madness!)</li>
<li>ARM chroot</li>
<li>Raspbian fat Docker container</li>
<li>Raspbian image booted under QEMU</li>
</ol>
<p>After some playing around, the QEMU route seemed like the best option. If you'd
like to do the same, the steps I took are fairly simple:</p>
<p>First off, we need to get a disk image. The images provided from the Raspberry
Pi site need some small modifications to run under QEMU, so we need to mount
and edit it. I'm using the <tt class="docutils literal"><span class="pre">2015-11-21-raspbian-jessie-lite.img</span></tt> image from
<a class="reference external" href="https://www.raspberrypi.org/downloads/raspbian/">https://www.raspberrypi.org/downloads/raspbian/</a>.</p>
<p>This image contains two partitions, a small boot partition (FAT) which contains
a few config files and a kernel, and the main ext4 root partition. The latter
is the partition we're interested in. You can inspect the image with <tt class="docutils literal">fdisk</tt>
to show these:</p>
<pre class="literal-block">
~/g/dewi (master) $ fdisk -l 2015-11-21-raspbian-jessie-lite.img
Disk 2015-11-21-raspbian-jessie-lite.img: 1.4 GiB, 1458569216 bytes, 2848768 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xb3c5e39a

Device                               Boot  Start     End Sectors  Size Id Type
2015-11-21-raspbian-jessie-lite.img1        8192  131071  122880   60M  c W95 FAT32 (LBA)
2015-11-21-raspbian-jessie-lite.img2      131072 2848767 2717696  1.3G 83 Linux
</pre>
<p>Note the start of the partition we're interested in (131072). This is the
offset from the start of the image in terms of number of sectors. The sector
size is 512, so the actual offset in terms of bytes is 131072 × 512 =
67108864.</p>
<p>Armed with this knowledge, we can mount the image and edit files on it
interactively.</p>
<p>First, create a directory to mount the image:</p>
<pre class="literal-block">
$ mkdir raspbian-jessie-mount-point
</pre>
<p>then mount the image:</p>
<pre class="literal-block">
$ sudo mount -o loop,offset=67108864 2015-11-21-raspbian-jessie-lite.img \
  raspbian-jessie-mount-point
</pre>
<p>Now it's time to comment out a bunch of things.</p>
<ol class="arabic simple">
<li>Open <tt class="docutils literal"><span class="pre">raspbian-jessie-mount-point/etc/ld.so.preload</span></tt> in an editor of your
choice and comment out all lines.</li>
<li>Do the same and comment out all lines related to <tt class="docutils literal">mmccblk</tt> in
<tt class="docutils literal"><span class="pre">raspbian-jessie-mount-point/etc/fstab</span></tt></li>
</ol>
<p>After these edits have been made, unmount the image:</p>
<pre class="literal-block">
$ sudo umount raspbian-jessie-mount-point
</pre>
<p>The modified image can now be saved and backed up somewhere. I took a copy and
compressed it to save on space:</p>
<pre class="literal-block">
$ xz 2015-11-21-raspbian-jessie-lite.img
</pre>
<p>Now we have an image to boot, we need a kernel to run. Sadly, a modified
kernel is required, since QEMU does not support raspberry pi hardware. Luckily
the work of patching and building has already been done by someone else.
<a class="reference external" href="https://github.com/polaco1782/raspberry-qemu">https://github.com/polaco1782/raspberry-qemu</a> appears to work well.</p>
<p>Clone that repository and copy <tt class="docutils literal"><span class="pre">kernel-qemu</span></tt>:</p>
<pre class="literal-block">
$ git clone git&#64;github.com:polaco1782/raspberry-qemu.git
$ cp raspberry-qemu/kernel-qemu .
</pre>
<p>At this point, booting should be possible. To test, first install
<tt class="docutils literal"><span class="pre">qemu-system-arm</span></tt>.</p>
<p>If you're on Fedora:</p>
<pre class="literal-block">
$ sudo dnf install qemu-system-arm
</pre>
<p>Or Debian/Ubuntu:</p>
<pre class="literal-block">
$ sudo apt install qemu-system-arm
</pre>
<p>Then run:</p>
<pre class="literal-block">
$ qemu-system-arm \
    -kernel kernel-qemu \
    -cpu arm1176 \
    -m 256 \
    -M versatilepb \
    -no-reboot \
    -serial stdio \
    -display none \
    -append &quot;root=/dev/sda2 panic=1 rootfstype=ext4 rw&quot; \
    -net user,hostfwd=tcp::10022-:22 \
    -net nic -hda \
    2015-11-21-raspbian-jessie-lite.img
</pre>
<p>Note the option <tt class="docutils literal"><span class="pre">-net</span> <span class="pre">user,hostfwd=tcp::10022-:22</span></tt>. This forwards port 22 on
raspbian to 10022 on the host, allowing us to ssh into the booted VM.</p>
<p>You should see some output similar to:</p>
<pre class="literal-block">
pulseaudio: pa_context_connect() failed
pulseaudio: Reason: Connection refused
pulseaudio: Failed to initialize PA contextaudio: Could not init `pa' audio driver
ALSA lib confmisc.c:768:(parse_card) cannot find card '0'
ALSA lib conf.c:4248:(_snd_config_evaluate) function snd_func_card_driver returned error: No such file or directory
ALSA lib confmisc.c:392:(snd_func_concat) error evaluating strings
ALSA lib conf.c:4248:(_snd_config_evaluate) function snd_func_concat returned error: No such file or directory
ALSA lib confmisc.c:1251:(snd_func_refer) error evaluating name
ALSA lib conf.c:4248:(_snd_config_evaluate) function snd_func_refer returned error: No such file or directory
ALSA lib conf.c:4727:(snd_config_expand) Evaluate error: No such file or directory
ALSA lib pcm.c:2239:(snd_pcm_open_noupdate) Unknown PCM default
alsa: Could not initialize DAC
alsa: Failed to open `default':
alsa: Reason: No such file or directory
ALSA lib confmisc.c:768:(parse_card) cannot find card '0'
ALSA lib conf.c:4248:(_snd_config_evaluate) function snd_func_card_driver returned error: No such file or directory
ALSA lib confmisc.c:392:(snd_func_concat) error evaluating strings
ALSA lib conf.c:4248:(_snd_config_evaluate) function snd_func_concat returned error: No such file or directory
ALSA lib confmisc.c:1251:(snd_func_refer) error evaluating name
ALSA lib conf.c:4248:(_snd_config_evaluate) function snd_func_refer returned error: No such file or directory
ALSA lib conf.c:4727:(snd_config_expand) Evaluate error: No such file or directory
ALSA lib pcm.c:2239:(snd_pcm_open_noupdate) Unknown PCM default
alsa: Could not initialize DAC
alsa: Failed to open `default':
alsa: Reason: No such file or directory
audio: Failed to create voice `lm4549.out'
Uncompressing Linux... done, booting the kernel.
</pre>
<p>Test if a login works:</p>
<pre class="literal-block">
$ ssh localhost -o StrictHostKeyChecking=no -p 10022 -l pi
</pre>
<p>The password should be the default <tt class="docutils literal">raspberry</tt>, unless you changed it
earlier.</p>
<p>If this all works, you can start writing your <tt class="docutils literal">.travis.yml</tt> to boot this VM
on Travis CI runs. You should first enable travis commit hooks on your
repository (read the <a class="reference external" href="https://docs.travis-ci.com/user/getting-started/">getting started guide</a>), then start writing a
configuration file. A simple version of the config file to start off:</p>
<div class="highlight"><pre><span></span><span class="n">language</span><span class="p">:</span> <span class="n">generic</span>
<span class="n">sudo</span><span class="p">:</span> <span class="n">true</span>
<span class="n">dist</span><span class="p">:</span> <span class="n">trusty</span>

<span class="n">before_install</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
    <span class="o">-</span> <span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">arm</span> <span class="n">wget</span> <span class="n">xz</span><span class="o">-</span><span class="n">utils</span> <span class="n">sshpass</span>

<span class="n">install</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">wget</span> <span class="s2">&quot;https://super-secret-location.com/2015-11-21-raspbian-jessie-lite.img.xz&quot;</span>
    <span class="o">-</span> <span class="n">unxz</span> <span class="s2">&quot;2015-11-21-raspbian-jessie-lite.img.xz&quot;</span>
    <span class="o">-</span> <span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">polaco1782</span><span class="o">/</span><span class="n">raspberry</span><span class="o">-</span><span class="n">qemu</span><span class="o">.</span><span class="n">git</span>

<span class="n">before_script</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">arm</span> <span class="o">-</span><span class="n">kernel</span> <span class="n">raspberry</span><span class="o">-</span><span class="n">qemu</span><span class="o">/</span><span class="n">kernel</span><span class="o">-</span><span class="n">qemu</span> <span class="o">-</span><span class="n">cpu</span> <span class="n">arm1176</span> <span class="o">-</span><span class="n">m</span> <span class="mi">256</span> <span class="o">-</span><span class="n">M</span> <span class="n">versatilepb</span> <span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">reboot</span> <span class="o">-</span><span class="n">serial</span> <span class="n">stdio</span> <span class="o">-</span><span class="n">append</span> <span class="s2">&quot;root=/dev/sda2 panic=1 rootfstype=ext4 rw&quot;</span> <span class="o">-</span><span class="n">net</span> <span class="n">user</span><span class="p">,</span><span class="n">hostfwd</span><span class="o">=</span><span class="n">tcp</span><span class="p">::</span><span class="mi">10022</span><span class="o">-</span><span class="p">:</span><span class="mi">22</span> <span class="o">-</span><span class="n">net</span> <span class="n">nic</span> <span class="o">-</span><span class="n">display</span> <span class="n">none</span> <span class="o">-</span><span class="n">hda</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="n">raspbian</span><span class="o">-</span><span class="n">jessie</span><span class="o">-</span><span class="n">lite</span><span class="o">.</span><span class="n">img</span> <span class="o">&amp;</span>
    <span class="o">-</span> <span class="o">./</span><span class="n">test</span><span class="o">/</span><span class="n">wait</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="n">ssh</span>

<span class="n">script</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">sshpass</span> <span class="o">-</span><span class="n">p</span> <span class="n">raspberry</span> <span class="n">ssh</span> <span class="n">localhost</span> <span class="o">-</span><span class="n">o</span> <span class="n">StrictHostKeyChecking</span><span class="o">=</span><span class="n">no</span> <span class="o">-</span><span class="n">p</span> <span class="mi">10022</span> <span class="o">-</span><span class="n">l</span> <span class="n">pi</span> <span class="s2">&quot;cat /etc/os-release&quot;</span>
    <span class="c1"># whatever you want to test here</span>
</pre></div>
<p>You should note this requires a mirror of the image created in the earlier
steps. Each CI run will have to download and decompress the image. With Travis
Pro, I believe you might be able to do something different and cache it, but I
didn't investigate this.</p>
<p>This runs <tt class="docutils literal"><span class="pre">qemu-system-arm</span></tt> in the background. In order to wait until the VM
is ready, I made a crude script named <tt class="docutils literal"><span class="pre">wait-for-ssh</span></tt> to ping the ssh port
until it responded:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>

<span class="k">while</span> true<span class="p">;</span> <span class="k">do</span>
    <span class="k">if</span> nc -z localhost <span class="m">10022</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;Found something on port 10022!&quot;</span>
        <span class="nb">exit</span>
    <span class="k">else</span>
        <span class="nb">echo</span> <span class="s2">&quot;Nothing found on port 10022, sleeping...&quot;</span>
        sleep 10
    <span class="k">fi</span>
<span class="k">done</span>
</pre></div>
<p>When this is done, you can actually test the stuff you wanted to test in the
first place! In the example <tt class="docutils literal">.travis.yml</tt>, I do a sanity check and cat
<tt class="docutils literal"><span class="pre">/etc/os-release</span></tt>, expecting something like:</p>
<pre class="literal-block">
PRETTY_NAME=&quot;Raspbian GNU/Linux 8 (jessie)&quot;
NAME=&quot;Raspbian GNU/Linux&quot;
VERSION_ID=&quot;8&quot;
VERSION=&quot;8 (jessie)&quot;
ID=raspbian
ID_LIKE=debian
HOME_URL=&quot;http://www.raspbian.org/&quot;
SUPPORT_URL=&quot;http://www.raspbian.org/RaspbianForums&quot;
BUG_REPORT_URL=&quot;http://www.raspbian.org/RaspbianBugs&quot;
</pre>
<p>Now you have a little Raspbian VM booted on every commit. Run some ansible or
puppet against it and you're done. Happy testing!</p>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h3><a href="./kpatch-package-builder">kpatch-package-builder 0.1.0</a></h3>
  </div>
  <div class="article_text">
    <p>As part of <a class="reference external" href="https://developers.google.com/open-source/gsoc/">Google Summer of Code</a>, I've been working with the
CentOS project to create a delivery and build system to provide easy and
automatic delivery of patches to a running linux kernel. CentOS 7 currently has
support for live patching a running kernel (via the kpatch kernel module and
the surrounding userland tools), but crafting a patch and applying it is a
currently a very manual process. The overall aim of the project is to make
applying kernel fixes an easy and automatic process, which will make it easier
to keep a CentOS installation more secure by without having to schedule
downtime.</p>
<p>As the first part of this project, I've been writing
<tt class="docutils literal"><span class="pre">kpatch-package-builder</span></tt>, a tool which generates RPM packages containing a
kernel module which patchs the currently running kernel.  These distributable
packages contain a single kernel patch, so standard package management tools,
such as dnf and yum can install and manage them.</p>
<p>This first version is pretty simple. You create a patch against the source of the
kernel you want to modify, then run <tt class="docutils literal"><span class="pre">kpatch-package-builder</span></tt> with the patch
name as the last argument. The output can either be a built .rpm file, or the
raw spec.</p>
<p>By default <tt class="docutils literal"><span class="pre">kpatch-package-builder</span></tt> outputs an RPM .spec file, which can be
used to build the RPM. This is a very simple spec, which just specifies the
name of the package, description, and other common package metadata. The name
of the package currently is based off the patch filename with a prefix of
<tt class="docutils literal"><span class="pre">kpatch-module-</span></tt>, which allows these packages to be simply distinguished.
Future versions will have a series of virtual dependencies to prevent patch
collisions, but that's something for a future post.</p>
<p>When given the <tt class="docutils literal"><span class="pre">-b</span></tt> or <tt class="docutils literal"><span class="pre">--build-rpm</span></tt> option, <tt class="docutils literal"><span class="pre">kpatch-package-builder</span></tt>
will invoke rpmbuild and build the package in place. The makes the kernel patch
to distributable package a single step.</p>
<p>As an example, creating a package from a patch file:</p>
<pre class="code bash literal-block">
<span class="o">[</span>vagrant&#64;localhost ~<span class="o">]</span>$ kpatch-package-builder -b livepatch-test.patch
kpatch-package-builder: generating spec file...
kpatch-package-builder: building RPM...
kpatch-package-builder: writing spec file to /tmp/kpatch_3I6mHJ.spec...
kpatch-package-builder: writing kpatch-module-livepatch-test-1-1.x86_64.rpm...
</pre>
<p>The default metadata associated with that generated package:</p>
<pre class="code bash literal-block">
<span class="o">[</span>vagrant&#64;localhost ~<span class="o">]</span>$ rpm -qip kpatch-module-livepatch-test-1-1.x86_64.rpm
Name        : kpatch-module-livepatch-test
Version     : 1
Release     : 1
Architecture: x86_64
Install Date: <span class="o">(</span>not installed<span class="o">)</span>
Group       : System Environment/Kernel
Size        : 281661
License     : GPLv2
Signature   : <span class="o">(</span>none<span class="o">)</span>
Source RPM  : kpatch-module-livepatch-test-1-1.src.rpm
Build Date  : Wed <span class="m">24</span> Jun <span class="m">2015</span> 15:26:46 EDT
Build Host  : localhost
Relocations : <span class="o">(</span>not relocatable<span class="o">)</span>
Summary     : kpatch livepatch module
Description :
Package generated from livepatch-test.patch by kpatch-package-builder
</pre>
<p>The contents of the package:</p>
<pre class="code bash literal-block">
<span class="o">[</span>vagrant&#64;localhost ~<span class="o">]</span>$ rpm -qlp kpatch-module-livepatch-test-1-1.x86_64.rpm
/var/lib/kpatch/3.10.0-229.el7.x86_64/kpatch-livepatch-test.ko
</pre>
<p>The current options available:</p>
<pre class="code bash literal-block">
<span class="o">[</span>vagrant&#64;localhost ~<span class="o">]</span>$ kpatch-package-builder -h
usage: kpatch-package-builder <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>-v<span class="o">]</span> <span class="o">[</span>-o FILE <span class="p">|</span> -b<span class="o">]</span> <span class="o">[</span>-k VERSION<span class="o">]</span> <span class="o">[</span>-a ARCH<span class="o">]</span>
                              <span class="o">[</span>--set-release NUM<span class="o">]</span> <span class="o">[</span>--set-version NUM<span class="o">]</span> <span class="o">[</span>-d<span class="o">]</span>
                              PATCH

Build an RPM package or an RPM spec file to install and manage a kpatch
livepatch module.

positional arguments:
  PATCH                 patch file from which to build the livepatch module

optional arguments:
  -h, --help            show this <span class="nb">help</span> message and <span class="nb">exit</span>
  -v, --version         show program<span class="err">'</span>s version number and <span class="nb">exit</span>
  -o FILE, --output FILE
                        name of output spec file
  -b, --build-rpm       build an RPM package
  -k VERSION, --kernel VERSION
                        target kernel version to build the livepatch module
                        against. Defaults to the currently running version
  -a ARCH, --arch ARCH  architecture to compile the patch against
  --set-release NUM     package release version
  --set-version NUM     package version number
  -d, --debug           print debug information

Usage examples:

Build an RPM package <span class="k">for</span> a given patch:

    $ kpatch-package-builder --build-rpm module.patch

Generate a spec file to later build into an RPM:

    $ kpatch-package-builder --output module.spec module.patch
</pre>
<p>If you want to test this or use it yourself, the code lives at <a class="reference external" href="https://github.com/centos-livepatching/kpatch-package-builder">https://github.com/centos-livepatching/kpatch-package-builder</a>.</p>
<div class="section" id="future-work">
<h2>Future work</h2>
<p>Next up is the rest of the tooling to make building and distributing a series
of patches across a set of kernel versions easy. This will be working on top of
the basic kpatch-package-builder functionality to allow building many versions
of packages for particular kernels.</p>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h3><a href="./vagrant-fedora-21">Vagrant on fedora 21 and later</a></h3>
  </div>
  <div class="article_text">
    <p>Vagrant is <a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1020456">now packaged</a> in Fedora 21 and later versions, which is great news.
No more messing around with the horror of rvm!</p>
<p>After installing vagrant and the libvirt plugin with yum:</p>
<pre class="literal-block">
$ sudo yum install vagrant vagrant-libvirt
</pre>
<p>I got some syntax errors from Vagrant:</p>
<pre class="literal-block">
$ vagrant up
/usr/share/vagrant/lib/vagrant/pre-rubygems.rb:19:in `require_relative': /usr/share/vagrant/lib/vagrant/bundler.rb:217: syntax error, unexpected tPOW (SyntaxError)
    def internal_install(plugins, update, **extra)
                                            ^
/usr/share/vagrant/lib/vagrant/bundler.rb:298: class definition in method body
/usr/share/vagrant/lib/vagrant/bundler.rb:315: class definition in method body
/usr/share/vagrant/lib/vagrant/bundler.rb:368: syntax error, unexpected keyword_end, expecting $end
    from /usr/share/vagrant/lib/vagrant/pre-rubygems.rb:19:in `&lt;main&gt;'
</pre>
<p>This was caused by rvm having an old version of ruby installed, which is what
was installed when I installed vagrant on this machine initially:</p>
<pre class="literal-block">
$ ruby --version
ruby 1.9.3p545 (2014-02-24 revision 45159) [x86_64-linux]
</pre>
<p>Luckily you can just:</p>
<pre class="literal-block">
$ rvm implode
</pre>
<p>and everything will be happy, where happy is defined by vagrant running and
having the fewest versions of ruby installed.</p>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h3><a href="./interlude">A brief five year interlude</a></h3>
  </div>
  <div class="article_text">
    <p>I've since done my GCSE and A-level exams, and am now half way
through university.</p>
<p>Some sailing robots made with friends from my university:</p>
<img alt="" src="./images/dewi.jpg" />
<img alt="" src="./images/kitty.jpg" />
<p>Old posts begin here:</p>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h3><a href="./control-vagalume-from-python">Controlling vagalume last.fm client using python</a></h3>
  </div>
  <div class="article_text">
    <p>I've recently been playing with the docky python bindings, and started by
writing a helper to interact with <a class="reference external" href="http://vagalume.igalia.com/">Vagalume</a>, a
lightweight last.fm client (I later added it to <a class="reference external" href="https://launchpad.net/vagalume-docky">a project on launchpad</a>). The vagalume DBus methods and
signals are mostly undocumented, but they can be found lurking around after a
quick look at <a class="reference external" href="http://gitorious.org/vagalume/vagalume/blobs/master/src/dbus.h">some of the source code</a>.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dbus</span>
<span class="kn">import</span> <span class="nn">gobject</span>
<span class="kn">from</span> <span class="nn">dbus.mainloop.glib</span> <span class="kn">import</span> <span class="n">DBusGMainLoop</span>

<span class="k">class</span> <span class="nc">Vagalume</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dbus</span><span class="o">.</span><span class="n">mainloop</span><span class="o">.</span><span class="n">glib</span><span class="o">.</span><span class="n">DBusGMainLoop</span><span class="p">(</span><span class="n">set_as_default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dbus</span><span class="o">.</span><span class="n">SessionBus</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">player</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="s1">&#39;com.igalia.vagalume&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;/com/igalia/vagalume&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">add_signal_receiver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">song_changed</span><span class="p">,</span>
                                     <span class="n">dbus_interface</span><span class="o">=</span><span class="s1">&#39;com.igalia.vagalume&#39;</span><span class="p">,</span>
                                     <span class="n">signal_name</span><span class="o">=</span><span class="s1">&#39;notify&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">song_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;stopped&#39;</span><span class="p">:</span>
            <span class="c1">#do something when the player is stopped</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;playing&#39;</span><span class="p">:</span>
            <span class="n">artist</span> <span class="o">=</span> <span class="n">args</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">args</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">album</span> <span class="o">=</span> <span class="n">args</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="c1">#do something with the data here...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">playing</span><span class="p">(</span><span class="n">artist</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">album</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stopped</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Run when music is stopped&#39;&#39;&#39;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">playing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">artist</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">album</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Run when new song is played&#39;&#39;&#39;</span>
        <span class="k">pass</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Vagalume</span><span class="p">()</span>

    <span class="c1"># gtk mainloop can be used if you&#39;re using this as part of a gtk app</span>
    <span class="n">mainloop</span> <span class="o">=</span> <span class="n">gobject</span><span class="o">.</span><span class="n">MainLoop</span><span class="p">(</span><span class="n">is_running</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">mainloop</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
<p>You'll probably notice the method <tt class="docutils literal">song_changed</tt>. This is a method which is
registered with DBus and run each time the <tt class="docutils literal">'notify'</tt> signal is emitted from
vagalume. This checks whether the notification is due to vagalume starting a
new song or stopping the current one and runs either <tt class="docutils literal">self.stopped</tt> or
<tt class="docutils literal">self.playing</tt>. These two methods by default do nothing, so subclassing
<tt class="docutils literal">Vagalume</tt> to make them do something useful is good:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyFancyVagalume</span><span class="p">(</span><span class="n">Vagalume</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">stopped</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s1">&#39;just stopped the beat&#39;</span>

    <span class="k">def</span> <span class="nf">playing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">artist</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">album</span><span class="p">):</span>
        <span class="k">print</span> <span class="s1">&#39;now playing &quot;</span><span class="si">%s</span><span class="s1">&quot; by </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">artist</span><span class="p">)</span>
</pre></div>
<p>To interact with vagalume do something like:</p>
<div class="highlight"><pre><span></span><span class="n">vagalume</span> <span class="o">=</span> <span class="n">Vagalume</span><span class="p">()</span>

<span class="c1"># do anything you want with dbus</span>
<span class="n">vagalume</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">Play</span><span class="p">()</span>
<span class="n">vagalume</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">Skip</span><span class="p">()</span>
<span class="n">vagalume</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">LoveTrack</span><span class="p">()</span>
<span class="n">vagalume</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">BanTrack</span><span class="p">()</span>
<span class="n">vagalume</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">Stop</span><span class="p">()</span>
</pre></div>
<p>take a look at the source
(<a class="reference external" href="http://gitorious.org/vagalume/vagalume/blobs/master/src/dbus.h">http://gitorious.org/vagalume/vagalume/blobs/master/src/dbus.h</a>) for all of the
functions available</p>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h3><a href="./screenshots-with-python-image-library">Grabbing screenshots as a Python Image Library <tt class="docutils literal">Image</tt> type</a></h3>
  </div>
  <div class="article_text">
    <p>A couple of days ago I needed to take screenshots of my linux desktop's screen and
manipulate these captured images using Python Image Library (PIL). I wrote a
small python class to do the work of taking the screenshot and returning a PIL
<tt class="docutils literal">Image</tt> object for use in the rest of the system I was writing.</p>
<p>The code ended up being simpler than I expected, mostly because <a class="reference external" href="http://en.wikipedia.org/wiki/GDK">GDK</a>, the library used as an intermediary
between GTK and the low-level window manager and display server commands, does
all the heavy lifting.</p>
<div class="section" id="method">
<h2>Method</h2>
<p>I wanted to take many screenshots during a run of the program I was writing, so
allocated a persistent <tt class="docutils literal">gtk.gdk.Pixbuf</tt> object to store the captured image
in. This object has a handy <tt class="docutils literal">get_from_drawable</tt> method. Of course, the X11
root window is a drawable, so by using <tt class="docutils literal">gtk.gdk.get_default_root_window()</tt> we
can copy each pixel into our buffer.</p>
<p>Once the <tt class="docutils literal">Pixbuf</tt> is full, an <tt class="docutils literal">Image</tt> needs to be created from it, since
that was the original aim. Luckily, there's <tt class="docutils literal">Image.frombuffer</tt> to do all the
hard work when combined with <tt class="docutils literal">Pixbuf.get_pixels()</tt>.</p>
<p>Full code:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">Image</span><span class="o">,</span> <span class="nn">gtk</span>

<span class="k">class</span> <span class="nc">Screenshotter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img_width</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">gdk</span><span class="o">.</span><span class="n">screen_width</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img_height</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">gdk</span><span class="o">.</span><span class="n">screen_height</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">screengrab</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">gdk</span><span class="o">.</span><span class="n">Pixbuf</span><span class="p">(</span>
            <span class="n">gtk</span><span class="o">.</span><span class="n">gdk</span><span class="o">.</span><span class="n">COLORSPACE_RGB</span><span class="p">,</span>
            <span class="bp">False</span><span class="p">,</span>
            <span class="mi">8</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">img_width</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">img_height</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">take</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screengrab</span><span class="o">.</span><span class="n">get_from_drawable</span><span class="p">(</span>
            <span class="n">gtk</span><span class="o">.</span><span class="n">gdk</span><span class="o">.</span><span class="n">get_default_root_window</span><span class="p">(),</span>
            <span class="n">gtk</span><span class="o">.</span><span class="n">gdk</span><span class="o">.</span><span class="n">colormap_get_system</span><span class="p">(),</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">img_width</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">img_height</span>
        <span class="p">)</span>

        <span class="n">final_screengrab</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span>
            <span class="s2">&quot;RGB&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_height</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screengrab</span><span class="o">.</span><span class="n">get_pixels</span><span class="p">(),</span>
            <span class="s2">&quot;raw&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RGB&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screengrab</span><span class="o">.</span><span class="n">get_rowstride</span><span class="p">(),</span>
            <span class="mi">1</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">final_screengrab</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">screenshot</span> <span class="o">=</span> <span class="n">Screenshotter</span><span class="p">()</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">screenshot</span><span class="o">.</span><span class="n">take</span><span class="p">()</span>
</pre></div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h3><a href="./taylortype">LaTeX in your system tray</a></h3>
  </div>
  <div class="article_text">
    <p>Whilst procrastinating on writing GCSE physics coursework, I thought it would
be neat to have LaTeX run in the background and notify you when the document
you're working on contains errors.</p>
<img alt="" src="./images/taylortype0.png" />
<p>I wrote a python application which puts a small icon in the system tray. You
can configure it to compile a LaTeX document.</p>
<p>It has a couple of settings for things like input file, output directory and
automatic PDF opening (useful with evince, since opening refreshes the file if
it is currently open in an existing evince window).  It supports simple error
messages for both LaTeX and BibTeX.</p>
<img alt="" src="./images/taylortype1.png" />
<p>It uses GTK for the system tray icon, and libnotify to display the error
message notifications.</p>
<p>The project is on launchpad here: <a class="reference external" href="https://launchpad.net/taylortype">https://launchpad.net/taylortype</a></p>
<p>There's a small site on sourceforge: <a class="reference external" href="http://taylortype.sourceforge.net/">http://taylortype.sourceforge.net/</a></p>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h3><a href="./green-blue-thing">Green/blue thing</a></h3>
  </div>
  <div class="article_text">
    <iframe
src="//player.vimeo.com/video/9220323?loop=1&title=0&byline=0&portrait=0"
width="676" height="500" frameborder="0" webkitallowfullscreen
mozallowfullscreen allowfullscreen></iframe>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h3><a href="./some-fur">Some fur</a></h3>
  </div>
  <div class="article_text">
    <p>Playing with fluffy things in blender.</p>
<img alt="" src="./images/large-brute-beast-pic34.jpg" />
<img alt="" src="./images/large-brute-beast-pic35.jpg" />
<img alt="" src="./images/smallhairythingshot43.jpg" />
<img alt="" src="./images/smallhairythingshot53.jpg" />

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h3><a href="./flying-thing">Low altitude flying craft</a></h3>
  </div>
  <div class="article_text">
    <img alt="" src="./images/rocket-thing-pic-10.jpg" />
<img alt="" src="./images/rocket-thing-pic-16.jpg" />
<img alt="" src="./images/rocket-thing-pic-19.jpg" />
<iframe
src="//player.vimeo.com/video/9167617?loop=1&title=0&byline=0&portrait=0"
width="627" height="400" frameborder="0" webkitallowfullscreen
mozallowfullscreen allowfullscreen></iframe>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h3><a href="./hoop-machine">Hoop machine</a></h3>
  </div>
  <div class="article_text">
    <p>Modeled in <a class="reference external" href="http://www.blender.org/">Blender</a> and rendered in <a class="reference external" href="www.kerkythea.net">Kerkythea</a>.</p>
<img alt="" src="./images/hoopmachine6.jpg" />

  </div>
</article>

<footer>
</footer>

    <div id="ending_message">
      <p>&copy; Louis Taylor. <a href=".">Index</a> &brvbar; <a href="./archives.html">Archives</a> &brvbar; <a href="http://getpelican.com" target="_blank">Pelican</a> &brvbar; <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">Theme</a>.</p>
    </div>
  </main>
</body>
</html>